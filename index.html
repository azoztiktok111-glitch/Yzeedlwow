<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA -->
<link rel="manifest" href="manifest.json">

<!-- Ø®Ø· -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Cairo', sans-serif;
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding-bottom: 100px;
}

.app {
  width: 100%;
  max-width: 420px;
  padding: 20px;
  text-align: center;
}

h1 { margin-bottom: 5px; }
.subtitle { color: #9ca3af; margin-bottom: 20px; }

.card {
  background: rgba(17, 24, 39, 0.85);
  border-radius: 18px;
  padding: 18px;
  backdrop-filter: blur(12px);
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  margin-bottom: 15px;
}

.row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #1f2937;
}

.row:last-child { border-bottom: none; }

.time { color: #38bdf8; font-weight: 700; }

#countdown { font-size: 0.95rem; color: #facc15; margin-top: 10px; }

button {
  background: #38bdf8;
  color: #020617;
  border: none;
  border-radius: 12px;
  padding: 12px;
  width: 100%;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 10px;
}

.small-text { margin-top: 10px; font-size: 0.85rem; color: #9ca3af; }

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-width: 420px;
  height: 60px;
  background: rgba(17,24,39,0.95);
  backdrop-filter: blur(12px);
  display: flex;
  justify-content: space-around;
  align-items: center;
  box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
  z-index: 100;
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
}

.bottom-bar button {
  background: none;
  border: none;
  color: #9ca3af;
  font-size: 0.9rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
}

.bottom-bar button.active, .bottom-bar button:hover { color: #38bdf8; }

.bottom-bar button i {
  font-size: 1.4rem;
  margin-bottom: 2px;
}

/* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª */
.option-card {
  background: rgba(17, 24, 39, 0.95);
  border-radius: 18px;
  padding: 15px;
  margin-top: 10px;
  text-align: center;
  display: none;
  backdrop-filter: blur(12px);
  box-shadow: 0 15px 30px rgba(0,0,0,0.35);
}

input[type="text"] {
  padding: 8px;
  border-radius: 8px;
  border: none;
  width: 80%;
  margin-top: 10px;
}

/* Ø³Ù‡Ù… Ø§Ù„Ù‚Ø¨Ù„Ø© */
#qiblaArrow {
  width: 80px;
  height: 80px;
  margin: 10px auto 0;
  transform-origin: 50% 50%;
  transition: transform 0.5s ease;
}
</style>

<!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>

<div class="app">
<h1>ğŸ•Œ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h1>
<div class="subtitle">Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ğŸ“</div>

<div id="locationPrompt" class="card">
<p>Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹Ùƒ ğŸŒ</p>
<button onclick="requestLocation()">ğŸ“ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
<p class="small-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù‡Ø§ØªÙÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ ğŸ“±</p>
</div>

<div class="card" id="prayers" style="display:none;"></div>

<div class="card" id="countdownCard" style="display:none;">
  <div id="countdown">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©â€¦</div>
</div>

<button onclick="enableNotifications()">ğŸ”” ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ø°Ø§Ù†</button>

<!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª -->
<div id="qiblaCard" class="option-card">
  <p>ğŸ§­ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©:</p>
  <img src="https://cdn-icons-png.flaticon.com/512/32/32195.png" id="qiblaArrow" alt="Ù‚Ø¨Ù„Ø©">
  <p id="qiblaDegree">...</p>
</div>

<div id="countersCard" class="option-card">
  <p>ğŸ“Š Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
</div>

<div id="searchCard" class="option-card">
  <p>ğŸ” ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¢Ø®Ø± Ø¨Ø§Ù„Ø¨Ø­Ø«</p>
  <input type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
  <button onclick="searchLocation()">ğŸ” Ø¨Ø­Ø«</button>
</div>
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ -->
<div class="bottom-bar">
  <button onclick="showOption('qiblaCard')"><i class="fas fa-compass"></i>Ù‚Ø¨Ù„Ø©</button>
  <button onclick="showOption('countersCard')"><i class="fas fa-chart-bar"></i>Ø¹Ø¯Ø§Ø¯</button>
  <button onclick="showOption('searchCard')"><i class="fas fa-map-marker-alt"></i>Ù…ÙˆÙ‚Ø¹</button>
</div>

<script>
let prayerTimes = null;
let nextPrayer = null;
let userLat = null;
let userLng = null;

const meccaLat = 21.4225;
const meccaLng = 39.8262;

function formatArabicTime(time24){
  let [h,m]=time24.split(":").map(Number);
  h=h%12||12;
  return `${h}:${m.toString().padStart(2,"0")}`;
}

function seconds(t){
  const [h,m]=t.split(":").map(Number);
  return h*3600 + m*60;
}

function getNextPrayer(times){
  const now=new Date();
  const nowSec = now.getHours()*3600 + now.getMinutes()*60;
  const list = [["Ø§Ù„ÙØ¬Ø±", times.Fajr], ["Ø§Ù„Ø¸Ù‡Ø±", times.Dhuhr], ["Ø§Ù„Ø¹ØµØ±", times.Asr], ["Ø§Ù„Ù…ØºØ±Ø¨", times.Maghrib], ["Ø§Ù„Ø¹Ø´Ø§Ø¡", times.Isha]];
  for(let p of list){ if(seconds(p[1])>nowSec) return p; }
  return ["Ø§Ù„ÙØ¬Ø±", times.Fajr];
}

function startCountdown(name,time){
  setInterval(()=>{
    const now = new Date();
    const [h,m]=time.split(":").map(Number);
    const target = new Date();
    target.setHours(h,m,0);
    if(target<now) target.setDate(target.getDate()+1);
    const diff = Math.floor((target-now)/1000);
    const hh=Math.floor(diff/3600);
    const mm=Math.floor((diff%3600)/60);
    const ss=diff%60;
    document.getElementById("countdown").innerText=`Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ${name} Ø¨Ø¹Ø¯ ${hh}:${mm.toString().padStart(2,"0")}:${ss.toString().padStart(2,"0")}`;
    if(diff===0 && Notification.permission==="granted"){
      new Notification("ğŸ•Œ Ø­Ø§Ù† Ø§Ù„Ø¢Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© "+name);
    }
  },1000);
}

function render(times){
  prayerTimes=times;
  const prayers=[["Ø§Ù„ÙØ¬Ø±", times.Fajr], ["Ø§Ù„Ø´Ø±ÙˆÙ‚", times.Sunrise], ["Ø§Ù„Ø¸Ù‡Ø±", times.Dhuhr], ["Ø§Ù„Ø¹ØµØ±", times.Asr], ["Ø§Ù„Ù…ØºØ±Ø¨", times.Maghrib], ["Ø§Ù„Ø¹Ø´Ø§Ø¡", times.Isha]];
  const box=document.getElementById("prayers");
  box.innerHTML="";
  prayers.forEach(p=>{
    box.innerHTML+=`<div class="row"><span>${p[0]}</span><span class="time">${formatArabicTime(p[1])}</span></div>`;
  });
  document.getElementById("locationPrompt").style.display="none";
  document.getElementById("prayers").style.display="block";
  document.getElementById("countdownCard").style.display="block";
  calculateQiblaArrow();
  nextPrayer=getNextPrayer(times);
  startCountdown(nextPrayer[0],nextPrayer[1]);
}

function requestLocation(){
  navigator.geolocation.getCurrentPosition(pos=>{
    userLat=pos.coords.latitude;
    userLng=pos.coords.longitude;
    fetch(`https://api.aladhan.com/v1/timings?latitude=${userLat}&longitude=${userLng}&method=4`)
    .then(r=>r.json())
    .then(d=>render(d.data.timings));
  }, err=>{
    alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¹Ø±Ø¶ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ø¯Ù‚Ø© ğŸ“");
  });
}

function calculateQiblaArrow(){
  if(userLat===null || userLng===null) return;
  const lat1 = userLat*Math.PI/180;
  const lon1 = userLng*Math.PI/180;
  const lat2 = meccaLat*Math.PI/180;
  const lon2 = meccaLng*Math.PI/180;
  const y = Math.sin(lon2-lon1)*Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
  let brng=Math.atan2(y,x)*180/Math.PI;
  brng=(brng+360)%360;
  document.getElementById("qiblaDegree").innerText = brng.toFixed(1)+"Â°";
  document.getElementById("qiblaArrow").style.transform=`rotate(${brng}deg)`;
}

function enableNotifications(){
  Notification.requestPermission().then(p=>{ if(p==="granted"){ alert("ØªÙ… ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ø°Ø§Ù† ğŸ””"); } });
}

function showOption(cardId){
  const cards=["qiblaCard","countersCard","searchCard"];
  cards.forEach(id=>{ document.getElementById(id).style.display=id===cardId?"block":"none"; });
}

function searchLocation(){
  const city=document.querySelector("#searchCard input").value;
  if(city) alert("ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹: "+city);
}

if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
</script>

</body>
</html>
