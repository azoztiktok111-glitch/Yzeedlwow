<div class="app">
  <h1>๐ ููุงููุช ุงูุตูุงุฉ</h1>
  <div class="subtitle">ุญุณุจ ูููุนู ุงูุญุงูู ๐</div>

  <!-- ุฑุณุงูุฉ ุทูุจ ุงููููุน -->
  <div id="locationPrompt" class="card">
    <p>ููุญุตูู ุนูู ููุงููุช ุงูุตูุงุฉ ุงูุฏูููุฉุ ูุฑุฌู ูุดุงุฑูุฉ ูููุนู ๐</p>
    <button onclick="requestLocation()">๐ ูุดุงุฑูุฉ ุงููููุน</button>
    <p style="margin-top: 10px; font-size: 0.85rem; color: #9ca3af;">
      ููููู ุฅุถุงูุฉ ูุฐุง ุงูุชุทุจูู ุฅูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ ููุงุชูู ูููุตูู ุงูุณุฑูุน ๐ฑ
    </p>
  </div>

  <div class="card" id="prayers" style="display:none;"></div>

  <div class="card" id="countdownCard" style="display:none;">
    <div id="countdown">ุฌุงุฑู ุญุณุงุจ ุงูุตูุงุฉ ุงููุงุฏูุฉโฆ</div>
  </div>

  <button onclick="enableNotifications()">๐ ุชูุนูู ุชูุจูู ุงูุฃุฐุงู</button>
</div>

<script>
  let prayerTimes = null;
  let nextPrayer = null;

  function formatArabicTime(time24) {
    let [h, m] = time24.split(":").map(Number);
    h = h % 12 || 12;
    return `${h}:${m.toString().padStart(2, "0")}`;
  }

  function seconds(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 3600 + m * 60;
  }

  function getNextPrayer(times) {
    const now = new Date();
    const nowSec = now.getHours() * 3600 + now.getMinutes() * 60;

    const list = [
      ["ุงููุฌุฑ", times.Fajr],
      ["ุงูุธูุฑ", times.Dhuhr],
      ["ุงูุนุตุฑ", times.Asr],
      ["ุงููุบุฑุจ", times.Maghrib],
      ["ุงูุนุดุงุก", times.Isha]
    ];

    for (let p of list) {
      if (seconds(p[1]) > nowSec) return p;
    }
    return ["ุงููุฌุฑ", times.Fajr];
  }

  function startCountdown(name, time) {
    setInterval(() => {
      const now = new Date();
      const [h, m] = time.split(":").map(Number);

      const target = new Date();
      target.setHours(h, m, 0);
      if (target < now) target.setDate(target.getDate() + 1);

      const diff = Math.floor((target - now) / 1000);
      const hh = Math.floor(diff / 3600);
      const mm = Math.floor((diff % 3600) / 60);
      const ss = diff % 60;

      document.getElementById("countdown").innerText =
        `ุงูุตูุงุฉ ุงููุงุฏูุฉ: ${name} ุจุนุฏ ${hh}:${mm.toString().padStart(2,"0")}:${ss.toString().padStart(2,"0")}`;

      if (diff === 0 && Notification.permission === "granted") {
        new Notification("๐ ุญุงู ุงูุขู ููุช ุตูุงุฉ " + name);
      }
    }, 1000);
  }

  function render(times) {
    prayerTimes = times;
    const prayers = [
      ["ุงููุฌุฑ", times.Fajr],
      ["ุงูุดุฑูู", times.Sunrise],
      ["ุงูุธูุฑ", times.Dhuhr],
      ["ุงูุนุตุฑ", times.Asr],
      ["ุงููุบุฑุจ", times.Maghrib],
      ["ุงูุนุดุงุก", times.Isha]
    ];

    const box = document.getElementById("prayers");
    box.innerHTML = "";

    prayers.forEach(p => {
      box.innerHTML += `
        <div class="row">
          <span>${p[0]}</span>
          <span class="time">${formatArabicTime(p[1])}</span>
        </div>
      `;
    });

    // ุฅุฎูุงุก ุทูุจ ุงููููุน ูุฅุธูุงุฑ ุงูุจุทุงูุงุช
    document.getElementById("locationPrompt").style.display = "none";
    document.getElementById("prayers").style.display = "block";
    document.getElementById("countdownCard").style.display = "block";

    nextPrayer = getNextPrayer(times);
    startCountdown(nextPrayer[0], nextPrayer[1]);
  }

  function requestLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
      fetch(`https://api.aladhan.com/v1/timings?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&method=4`)
        .then(r => r.json())
        .then(d => render(d.data.timings));
    }, err => {
      alert("ูุฑุฌู ุชูุนูู ูุดุงุฑูุฉ ุงููููุน ูุนุฑุถ ููุงููุช ุงูุตูุงุฉ ุจุฏูุฉ ๐");
    });
  }

  function enableNotifications() {
    Notification.requestPermission().then(p => {
      if (p === "granted") {
        alert("ุชู ุชูุนูู ุชูุจูู ุงูุฃุฐุงู ๐");
      }
    });
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
